<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Engine\Graphics\Tilemap.js - AtlantisEngine.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="AtlantisEngine.js"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Atlantis.app.html">Atlantis.app</a></li>
            
                <li><a href="../classes/Atlantis.AudioManager.html">Atlantis.AudioManager</a></li>
            
                <li><a href="../classes/Atlantis.ButtonState.html">Atlantis.ButtonState</a></li>
            
                <li><a href="../classes/Atlantis.Camera2D.html">Atlantis.Camera2D</a></li>
            
                <li><a href="../classes/Atlantis.ContentManager.html">Atlantis.ContentManager</a></li>
            
                <li><a href="../classes/Atlantis.DrawableGameComponent.html">Atlantis.DrawableGameComponent</a></li>
            
                <li><a href="../classes/Atlantis.Engine.html">Atlantis.Engine</a></li>
            
                <li><a href="../classes/Atlantis.Game.html">Atlantis.Game</a></li>
            
                <li><a href="../classes/Atlantis.GameComponent.html">Atlantis.GameComponent</a></li>
            
                <li><a href="../classes/Atlantis.Gamepad.html">Atlantis.Gamepad</a></li>
            
                <li><a href="../classes/Atlantis.GamepadAxis.html">Atlantis.GamepadAxis</a></li>
            
                <li><a href="../classes/Atlantis.GamepadButton.html">Atlantis.GamepadButton</a></li>
            
                <li><a href="../classes/Atlantis.GamepadState.html">Atlantis.GamepadState</a></li>
            
                <li><a href="../classes/Atlantis.GameTime.html">Atlantis.GameTime</a></li>
            
                <li><a href="../classes/Atlantis.GraphicsDevice.html">Atlantis.GraphicsDevice</a></li>
            
                <li><a href="../classes/Atlantis.input.html">Atlantis.input</a></li>
            
                <li><a href="../classes/Atlantis.KeyboardComponent.html">Atlantis.KeyboardComponent</a></li>
            
                <li><a href="../classes/Atlantis.KeyboardManager.html">Atlantis.KeyboardManager</a></li>
            
                <li><a href="../classes/Atlantis.KeyboardState.html">Atlantis.KeyboardState</a></li>
            
                <li><a href="../classes/Atlantis.Keys.html">Atlantis.Keys</a></li>
            
                <li><a href="../classes/Atlantis.MathHelpers.html">Atlantis.MathHelpers</a></li>
            
                <li><a href="../classes/Atlantis.Matrix.html">Atlantis.Matrix</a></li>
            
                <li><a href="../classes/Atlantis.Mouse.html">Atlantis.Mouse</a></li>
            
                <li><a href="../classes/Atlantis.MouseState.html">Atlantis.MouseState</a></li>
            
                <li><a href="../classes/Atlantis.MusicState.html">Atlantis.MusicState</a></li>
            
                <li><a href="../classes/Atlantis.Point.html">Atlantis.Point</a></li>
            
                <li><a href="../classes/Atlantis.Quaternion.html">Atlantis.Quaternion</a></li>
            
                <li><a href="../classes/Atlantis.Rectangle.html">Atlantis.Rectangle</a></li>
            
                <li><a href="../classes/Atlantis.RenderTarget.html">Atlantis.RenderTarget</a></li>
            
                <li><a href="../classes/Atlantis.Scene2D.html">Atlantis.Scene2D</a></li>
            
                <li><a href="../classes/Atlantis.screen.html">Atlantis.screen</a></li>
            
                <li><a href="../classes/Atlantis.SpriteAnimation.html">Atlantis.SpriteAnimation</a></li>
            
                <li><a href="../classes/Atlantis.SpriteAnimator.html">Atlantis.SpriteAnimator</a></li>
            
                <li><a href="../classes/Atlantis.SpriteBatch.html">Atlantis.SpriteBatch</a></li>
            
                <li><a href="../classes/Atlantis.SpriteEffect.html">Atlantis.SpriteEffect</a></li>
            
                <li><a href="../classes/Atlantis.SpriteFont.html">Atlantis.SpriteFont</a></li>
            
                <li><a href="../classes/Atlantis.SpriteGroup.html">Atlantis.SpriteGroup</a></li>
            
                <li><a href="../classes/Atlantis.SpriteSortMode.html">Atlantis.SpriteSortMode</a></li>
            
                <li><a href="../classes/Atlantis.State.html">Atlantis.State</a></li>
            
                <li><a href="../classes/Atlantis.StateManager.html">Atlantis.StateManager</a></li>
            
                <li><a href="../classes/Atlantis.StorageManager.html">Atlantis.StorageManager</a></li>
            
                <li><a href="../classes/Atlantis.Tilemap.html">Atlantis.Tilemap</a></li>
            
                <li><a href="../classes/Atlantis.TilemapLayer.html">Atlantis.TilemapLayer</a></li>
            
                <li><a href="../classes/Atlantis.TilemapLayerType.html">Atlantis.TilemapLayerType</a></li>
            
                <li><a href="../classes/Atlantis.TilemapProjection.html">Atlantis.TilemapProjection</a></li>
            
                <li><a href="../classes/Atlantis.Tileset.html">Atlantis.Tileset</a></li>
            
                <li><a href="../classes/Atlantis.TouchLocationState.html">Atlantis.TouchLocationState</a></li>
            
                <li><a href="../classes/Atlantis.TouchPanel.html">Atlantis.TouchPanel</a></li>
            
                <li><a href="../classes/Atlantis.TouchPanelState.html">Atlantis.TouchPanelState</a></li>
            
                <li><a href="../classes/Atlantis.Vector2.html">Atlantis.Vector2</a></li>
            
                <li><a href="../classes/Atlantis.Vector3.html">Atlantis.Vector3</a></li>
            
                <li><a href="../classes/Atlantis.Vector4.html">Atlantis.Vector4</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Atlantis.html">Atlantis</a></li>
            
                <li><a href="../modules/Engine.html">Engine</a></li>
            
                <li><a href="../modules/Framework.html">Framework</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: Engine\Graphics\Tilemap.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * AtlantisEngine.js a lightweight JavaScript game engine.
 *
 * @module Atlantis
 * @submodule Engine
 * @namespace Atlantis
 */

var Atlantis = window.Atlantis || {};

/**
 * Define the type of a layer
 * - Tiles
 * - Background
 * - Objects
 * @class TilemapLayerType
 * @static
 */
Atlantis.TilemapLayerType = {
    Tiles: &quot;tilelayer&quot;,
    Background: &quot;imagelayer&quot;,
    Objects: &quot;objectlayer&quot;
};

/**
 * Define the type of projection of the map
 * - Orthogonal (2D)
 * - Isometric (2D Iso)
 * @class TilemapProjection
 * @static
 */
Atlantis.TilemapProjection = {
    Orthogonal: &quot;orthogonal&quot;,
    Isometric: &quot;isometric&quot;
};

/**
 * Represent a tileset which is an image that contains many other images named tiles.
 * @class Tileset
 * @constructor
 * @param {Atlantis.Tileset|Object} tileset (optional) An object that contains all necessary data to construct a tileset.
 */
Atlantis.Tileset = function (tileset) {
    this.firstGID = +tileset.firstgid || 1;
    this.id = Atlantis.Tileset.Counter++;
    this.name = tileset.name || [&quot;Tileset_&quot;, this.id].join(&quot;&quot;);
    this.texture = tileset.texture;
    this.width = +tileset.imagewidth|0;
    this.height = +tileset.imageheight|0;
    this.margin = +tileset.margin|0;
    this.padding = +tileset.spacing|0;
    this.tileWidth = +tileset.tilewidth|0;
    this.tileHeight = +tileset.tileheight|0;
    this.properties = tileset.properties || {};
};

Atlantis.Tileset.Counter = 0;

/**
 * Represent a tilemap layer which contains a tileset or background.
 * @class TilemapLayer
 * @constructor
 * @param {Atlantis.TilemapLayer|Object} layer (optional) An object that contains all necessary data to construct a layer.
 */
Atlantis.TilemapLayer = function (layer) {
    var layer = layer || {};
    this.id = Atlantis.TilemapLayer.Counter++
	this.data = layer.data || [];
	this.type = layer.type || Atlantis.TilemapLayer.Tiles;
    this.visible = layer.visible;
    this.opacity = +layer.opacity;
    this.name = layer.name || [&quot;Layer_&quot;, this.id].join(&quot;&quot;);
    this.width = +layer.width|0;
	this.height = +layer.height|0;
    this.offset = { 
        x: +layer.x|0, 
        y: +layer.y|0 
    };
    this.properties = layer.properties || {};
    this.backgroundId = +layer.backgroundId || +this.properties.backgroundId || 0;
    this.tilesetId = +layer.tilesetId || +this.properties.tilesetId || 0;
};

Atlantis.TilemapLayer.Counter = 0;

/**
 * This class is responsible to store all data for drawing a tilemap.
 * A tilemap is composed of layers, tilesets and backgrounds.
 * @class Tilemap
 * @constructor
 * @param {Atlantis.Tilemap|Object} tilemap (optional) An object that contains tilemap data.
 */
Atlantis.Tilemap = function (tilemap) {
    var tilemap = tilemap || {};
    this.id = Atlantis.Tilemap.Counter++;
    this.name = tilemap.name || [&quot;Tilemap_&quot;, this.id].join(&quot;&quot;);
    this.version = +tilemap.version|0;
    this.projection = tilemap.orientation || tilemap.projection || Atlantis.TilemapProjection.Orthogonal;

    this.layers = tilemap.layers || [];
    this.tilesets = tilemap.tilesets || [];
    this.backgrounds = tilemap.backgrounds || [];
    
    this.width = +tilemap.width|0;
    this.height = +tilemap.height|0;
    this.tileWidth = +tilemap.tilewidth|0, 
    this.tileHeight = +tilemap.tileheight|0 
    this.mapWidth = this.width * this.tileWidth;
    this.mapHeight = this.height * this.tileHeight;
    
    this.properties = tilemap.properties || {};
    this.loaded = (typeof(tilemap.loaded) !== &quot;undefined&quot;) ? tilemap.loaded : false;
    this.visible = (typeof(tilemap.visible) !== &quot;undefined&quot;) ? tilemap.visible : true;

    this._cacheTilesCanvas = [];
};

Atlantis.Tilemap.Counter = 0;

Atlantis.Tilemap.prototype.update = function (camera) {
    // TODO : Add collision detection 
};

/**
 * Draw the tilemap if it&#x27;s visible and loaded.
 * @method draw
 * @param {Atlantis.SpriteBatch} spriteBatch An instance of SpriteBatch for drawing the tileset.
 * @param {Atlantis.Camera2D} camera The camera to use to defined what must be drawn.
 */
Atlantis.Tilemap.prototype.draw = function (spriteBatch, camera) {
    if (this.visible &amp;&amp; this.loaded) {
        for (var i = 0, l = this.layers.length; i &lt; l; i++) {
            if (this.layers[i].visible) {
                if (this.layers[i].type === Atlantis.TilemapLayerType.Background) {
                    this.drawBackground(spriteBatch, this.layers[i], this.backgrounds[this.layers[i].backgroundId])
                }
                else if (this.layers[i].type === Atlantis.TilemapLayerType.Tiles) {
                    this.drawLayer(spriteBatch, camera, this.layers[i], this.tilesets[this.layers[i].tilesetId]);
                }
            }
        }
    }
};

/**
 * Draw the background with this defined offset
 * @method drawBackground
 * @param {Atlantis.SpriteBatch} spriteBatch An instance of SpriteBatch for drawing the background.
 * @param {Atlantis.TilemapLayer} layer The layer to draw.
 * @param {Image|Canvas} background An image or canvas to draw as background.
 */
Atlantis.Tilemap.prototype.drawBackground = function (spriteBatch, layer, background) {
    spriteBatch.draw(background, { x: layer.offset.x, y: layer.offset.y });
};

/**
 * Draw tiles with the defined offset, spacing and margin
 * @method drawLayer
 * @param {Atlantis.SpriteBatch} spriteBatch An instance of SpriteBatch for drawing the tileset.
 * @param {Atlantis.Camera2D} camera The camera to use to defined what must be drawn.
 * @param {Atlantis.TilemapLayer} layer The layer to draw.
 * @param {Atlantis.Tileset} The tileset to use for drawing the layer.
 */
Atlantis.Tilemap.prototype.drawLayer = function (spriteBatch, camera, layer, tileset) { 
     var nbTileX = tileset.width / tileset.tileWidth,
         nbTileY = tileset.height / tileset.tileHeight;
    
    // posX/Y   : Relative position to the camera
    // start/End/X/Y : Start/End position for the render loop  
    var posX = camera.x / this.tileWidth,
        posY = camera.y / this.tileHeight
        startX = Math.floor(posX),
        startY = Math.floor(posY),
        stopX = Math.min(Math.round((camera.x + Atlantis.screen.width) / tileset.tileWidth) + 1, layer.width),
        stopY = Math.min(Math.round((camera.y + Atlantis.screen.height) / tileset.tileHeight) + 1, layer.height);
    
    // Source rectangle values for drawing a tile.
    var srcX = 0,
        srcY = 0,
        destX = 0,
        destY = 0,
        tileId = 0;
    
    for (var x = startX; x &lt; stopX; x++) {
        for (var y = startY; y &lt; stopY; y++) {
            tileId = layer.data[x + y * layer.width] - tileset.firstGID;

            // To prevent negative source rectangle
            if (tileId &gt;= 0) {
                srcX = tileId % nbTileX;
                srcY = Math.floor(tileId / nbTileX);
                srcX = (srcY &gt; 0) ? (srcX % (nbTileX * srcY)) : (srcX % nbTileX);   
                
                destX = ((x + layer.offset.x) - posX) * this.tileWidth;
                destY = ((y + layer.offset.y) - posY) * this.tileHeight;

                if (this.projection === Atlantis.TilemapProjection.Isometric) {
                    var isoX = (destX - destY);
                    var isoY = (destX + destY) / 2;
                    destX = isoX;
                    destY = isoY;
                }

                spriteBatch.draw(tileset.texture, { 
                    x: destX, 
                    y: destY, 
                    width: this.tileWidth, 
                    height: this.tileHeight
                }, 
                { 
                    x: srcX * tileset.tileWidth, 
                    y: srcY * tileset.tileHeight, 
                    width: tileset.tileWidth, 
                    height: tileset.tileHeight 
                });
            }
        }
    }
};

/**
 * Gets the tile index at the specified position.
 * @method getTileIdAt
 * @param {Number} layerIndex The index of the layer
 * @param {Number} x The position of the tile on X axis.
 * @param {Number} y The postion of the tile on Y axis.
 * @return {Number} Return the id of the tile at this position if exists, otherwise return 0.
 */
Atlantis.Tilemap.prototype.getTileIdAt = function (layerIndex, x, y) {
    if (this.layers[layerIndex]) {
        var layer = this.layers[layerIndex];
        var x = Math.floor(x / this.tileWidth);
        var y = Math.floor(y / this.tileHeight);
        return layer.data[x + y * layer.width];
    }
    
    return 0;
};

/**
 * Extract a tile from tileset and return a canvas element with the tile drawn in it.
 * It&#x27;s usefull to do some tests, such as pixel perfect. 
 * Note 1: that it&#x27;s work with a scale different to 1.
 * Note 2: The extraction is done once, the result is stored in a cache, so you can safely call this method.
 * @method getTileAt
 * @param {Atlantis.Tileset} tileset The tileset to use to extract the tile.
 * @param {Number} layerIndex The index of the layer
 * @param {Number} x The position of the tile on X axis.
 * @param {Number} y The postion of the tile on Y axis.
 * @return {HTMLCanvas} Return a canvas element of the specified tile if exists, otherwise return null.
 */
Atlantis.Tilemap.prototype.getTileAt = function (tileset, layerIndex, x, y) {
    if (this.layers[layerIndex]) {
        var layer = this.layers[layerIndex],
            tileId = this.getTileIdAt(layerIndex, x, y),
            cacheId = [layer.id, &quot;_&quot;, tileset.id, &quot;_&quot;, tileId].join(&quot;&quot;);

        if (!this._cacheTilesCanvas[cacheId]) {
            var canvas = document.createElement(&quot;canvas&quot;),
                context = canvas.getContext(&quot;2d&quot;);

            canvas.width = tileset.tileWidth;
            canvas.height = tileset.tileHeight;

            if (tileId &gt;= 0) {
                var nbTileX = tileset.imagewidth / tileset.tilewidth,
                    nbTileY = tileset.imageheight / tileset.tileheight,
                    srcX = tileId % nbTileX,
                    srcY = Math.floor(tileId / nbTileX);

                srcX = (srcY &gt; 0) ? (srcX % (nbTileX * srcY)) : (srcX % nbTileX);   
                    
                context.drawImage(tileset.texture, 
                    { 
                        x: srcX * tileset.tileWidth, 
                        y: srcY * tileset.tileHeight, 
                        width: tileset.tileWidth, 
                        height: tileset.tileHeight 
                    },
                    { 
                        x: 0, 
                        y: 0, 
                        width: this.tileWidth, 
                        height: this.tileHeight
                    }
                );

                this._cacheTilesCanvas[cacheId] = canvas;
                return canvas;
            }
        }
        else {
            return this._cacheTilesCanvas[cacheId];
        }
    }

    return null;
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
