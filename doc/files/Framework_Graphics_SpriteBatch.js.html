<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Framework\Graphics\SpriteBatch.js - AtlantisEngine.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="AtlantisEngine.js"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Atlantis.app.html">Atlantis.app</a></li>
            
                <li><a href="../classes/Atlantis.AudioManager.html">Atlantis.AudioManager</a></li>
            
                <li><a href="../classes/Atlantis.ButtonState.html">Atlantis.ButtonState</a></li>
            
                <li><a href="../classes/Atlantis.Camera2D.html">Atlantis.Camera2D</a></li>
            
                <li><a href="../classes/Atlantis.ContentManager.html">Atlantis.ContentManager</a></li>
            
                <li><a href="../classes/Atlantis.DrawableGameComponent.html">Atlantis.DrawableGameComponent</a></li>
            
                <li><a href="../classes/Atlantis.Engine.html">Atlantis.Engine</a></li>
            
                <li><a href="../classes/Atlantis.Game.html">Atlantis.Game</a></li>
            
                <li><a href="../classes/Atlantis.GameComponent.html">Atlantis.GameComponent</a></li>
            
                <li><a href="../classes/Atlantis.Gamepad.html">Atlantis.Gamepad</a></li>
            
                <li><a href="../classes/Atlantis.GamepadAxis.html">Atlantis.GamepadAxis</a></li>
            
                <li><a href="../classes/Atlantis.GamepadButton.html">Atlantis.GamepadButton</a></li>
            
                <li><a href="../classes/Atlantis.GamepadState.html">Atlantis.GamepadState</a></li>
            
                <li><a href="../classes/Atlantis.GameTime.html">Atlantis.GameTime</a></li>
            
                <li><a href="../classes/Atlantis.GraphicsDevice.html">Atlantis.GraphicsDevice</a></li>
            
                <li><a href="../classes/Atlantis.input.html">Atlantis.input</a></li>
            
                <li><a href="../classes/Atlantis.KeyboardComponent.html">Atlantis.KeyboardComponent</a></li>
            
                <li><a href="../classes/Atlantis.KeyboardManager.html">Atlantis.KeyboardManager</a></li>
            
                <li><a href="../classes/Atlantis.KeyboardState.html">Atlantis.KeyboardState</a></li>
            
                <li><a href="../classes/Atlantis.Keys.html">Atlantis.Keys</a></li>
            
                <li><a href="../classes/Atlantis.Level.html">Atlantis.Level</a></li>
            
                <li><a href="../classes/Atlantis.LevelManager.html">Atlantis.LevelManager</a></li>
            
                <li><a href="../classes/Atlantis.MathHelpers.html">Atlantis.MathHelpers</a></li>
            
                <li><a href="../classes/Atlantis.Matrix.html">Atlantis.Matrix</a></li>
            
                <li><a href="../classes/Atlantis.Mouse.html">Atlantis.Mouse</a></li>
            
                <li><a href="../classes/Atlantis.MouseState.html">Atlantis.MouseState</a></li>
            
                <li><a href="../classes/Atlantis.MusicState.html">Atlantis.MusicState</a></li>
            
                <li><a href="../classes/Atlantis.Point.html">Atlantis.Point</a></li>
            
                <li><a href="../classes/Atlantis.Preloader.html">Atlantis.Preloader</a></li>
            
                <li><a href="../classes/Atlantis.Quaternion.html">Atlantis.Quaternion</a></li>
            
                <li><a href="../classes/Atlantis.Random.html">Atlantis.Random</a></li>
            
                <li><a href="../classes/Atlantis.Rectangle.html">Atlantis.Rectangle</a></li>
            
                <li><a href="../classes/Atlantis.RenderTarget.html">Atlantis.RenderTarget</a></li>
            
                <li><a href="../classes/Atlantis.screen.html">Atlantis.screen</a></li>
            
                <li><a href="../classes/Atlantis.SpriteAnimation.html">Atlantis.SpriteAnimation</a></li>
            
                <li><a href="../classes/Atlantis.SpriteAnimator.html">Atlantis.SpriteAnimator</a></li>
            
                <li><a href="../classes/Atlantis.SpriteBatch.html">Atlantis.SpriteBatch</a></li>
            
                <li><a href="../classes/Atlantis.SpriteEffect.html">Atlantis.SpriteEffect</a></li>
            
                <li><a href="../classes/Atlantis.SpriteFont.html">Atlantis.SpriteFont</a></li>
            
                <li><a href="../classes/Atlantis.SpriteGroup.html">Atlantis.SpriteGroup</a></li>
            
                <li><a href="../classes/Atlantis.SpriteSortMode.html">Atlantis.SpriteSortMode</a></li>
            
                <li><a href="../classes/Atlantis.StorageManager.html">Atlantis.StorageManager</a></li>
            
                <li><a href="../classes/Atlantis.Tilemap.html">Atlantis.Tilemap</a></li>
            
                <li><a href="../classes/Atlantis.TilemapLayer.html">Atlantis.TilemapLayer</a></li>
            
                <li><a href="../classes/Atlantis.TilemapLayerType.html">Atlantis.TilemapLayerType</a></li>
            
                <li><a href="../classes/Atlantis.TilemapProjection.html">Atlantis.TilemapProjection</a></li>
            
                <li><a href="../classes/Atlantis.Tileset.html">Atlantis.Tileset</a></li>
            
                <li><a href="../classes/Atlantis.TmxLoader.html">Atlantis.TmxLoader</a></li>
            
                <li><a href="../classes/Atlantis.TouchLocationState.html">Atlantis.TouchLocationState</a></li>
            
                <li><a href="../classes/Atlantis.TouchPanel.html">Atlantis.TouchPanel</a></li>
            
                <li><a href="../classes/Atlantis.TouchPanelState.html">Atlantis.TouchPanelState</a></li>
            
                <li><a href="../classes/Atlantis.Vector2.html">Atlantis.Vector2</a></li>
            
                <li><a href="../classes/Atlantis.Vector3.html">Atlantis.Vector3</a></li>
            
                <li><a href="../classes/Atlantis.Vector4.html">Atlantis.Vector4</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Atlantis.html">Atlantis</a></li>
            
                <li><a href="../modules/Engine.html">Engine</a></li>
            
                <li><a href="../modules/Framework.html">Framework</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: Framework\Graphics\SpriteBatch.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * AtlantisEngine.js a lightweight JavaScript game engine.
 * @module Atlantis
 * @submodule Framework
 * @namespace Atlantis
 */

var Atlantis = window.Atlantis || {};

/**
 * Define the sort mode of a sprite batch.
 * - BackToFront: All items of the batch are drawn to the smallest to the biggest layer depth
 * - FrontToBack: All items of the batch are drawn to the biggest to the smallest layer depth
 * - Immediate: No sorting, all is drawn without layer depth sorting.
 * @class SpriteSortMode
 * @static
 */
Atlantis.SpriteSortMode = {
    BackToFront: 0,
    FrontToBack: 1,
    Immediate: 2
};

/**
 * Define an effect to apply on a sprite.
 * @class SpriteEffect
 * @static
 */
Atlantis.SpriteEffect = {
    None: 0,
    FlipHorizontaly: 1,
    FlipVerticaly: 2
};

Atlantis.BatchItemType = {
    Texture: 0,
    Font: 1
};   

/**
 * Define a SpriteBatch that is responsible to draw multiple elements on screen on one pass.
 * @class SpriteBatch
 * @constructor
 * @param {Atlantis.Graphics.GraphicsDevice} The graphics device.
 */
Atlantis.SpriteBatch = function (graphicsDevice) {
    this._graphicsDevice = graphicsDevice;

    // Canvas used to render all item of the batch.
    this._renderTarget = new Atlantis.RenderTarget(graphicsDevice.preferredBackBufferWidth, graphicsDevice.preferredBackBufferHeight, false);
    this._viewport = new Atlantis.Rectangle(0, 0, graphicsDevice.preferredBackBufferWidth, graphicsDevice.preferredBackBufferHeight);
    this._canvas = this._renderTarget.getCanvas();
    this._context = this._renderTarget.getContext();

    this._batchItems = [];
    this._batchStarted = false;
    this._spriteSortMode = Atlantis.SpriteSortMode.Immediate;
    this._transformMatrix = null;
    this._cacheColoredTextures = [];
    
    document.addEventListener(Atlantis.events.ResolutionChanged, this._onResize.bind(this), false);
};

Atlantis.SpriteBatch.prototype._onResize = function (event) {
    this._renderTarget.setSize(event.width, event.height);
    this._viewport.width = event.width;
    this._viewport.height = event.height;
};

/**
 * Begin the batch operation.
 * @method begin
 * @param {Atlantis.SpriteSortMode} The type of sorting to use (option, default is Immediate).
 * @param {Array} A transform matrix to apply for all items (optional). The matrix is a 3x3 matrix in a single array.
 *        - [ScaleX, SkewX, SkewY, ScaleY, TranslationX, TranslationY]
 */
Atlantis.SpriteBatch.prototype.begin = function (spriteSortMode, transformMatrix) {
    if (!this._batchStarted) {
        this._batchStarted = true;
        this._transformMatrix = transformMatrix ? (transformMatrix.length === 6 ? transformMatrix : null) : null;
        this._spriteSortMode = typeof(spriteSortMode) === &quot;number&quot; ? spriteSortMode : Atlantis.SpriteSortMode.Immediate;
        this._renderTarget.clear();
    }
};

Atlantis.SpriteBatch.prototype._sortBatchItem = function (itemA, itemB) {
    if (this._spriteSortMode === Atlantis.SpriteSortMode.BackToFront) {
        if (+itemA.layerDepth &gt; +itemB.layerDepth) {
            return 1;   
        }
        
        if (+itemA.layerDepth &lt; +itemB.layerDepth) {
            return -1;   
        }
        
        return 0;
    }
    else {
        if (+itemA.layerDepth &lt; +itemB.layerDepth) {
            return 1;   
        }
        
        if (+itemA.layerDepth &gt; +itemB.layerDepth) {
            return -1;   
        }
        
        return 0;
    }
};

/**
 * Execute the batch process and draw the result in the screen.
 * @method end
 */
Atlantis.SpriteBatch.prototype.end = function () {
    if (this._batchStarted) {
        var item = {};
        var that = this;

        if (this._spriteSortMode !== Atlantis.SpriteSortMode.Immediate) {
            this._batchItems = this._batchItems.sort(this._sortBatchItem.bind(this));
        }
        
        var fX, fY, fWidth, fHeight;
        var oX, oY;
        var testRectangle = new Atlantis.Rectangle();

        if (this._transformMatrix) {
            this._context.save();
            
            this._context.transform(
                this._transformMatrix[0], this._transformMatrix[1], this._transformMatrix[2],
                this._transformMatrix[3], this._transformMatrix[4], this._transformMatrix[5]);
        }
        
        for (var i = 0, l = this._batchItems.length; i &lt; l; i++) {
            item = this._batchItems[i];
            
            fX = item.destinationRectangle.x;
            fY = item.destinationRectangle.y;
            fWidth = item.destinationRectangle.width;
            fHeight = item.destinationRectangle.height;
            
            // If the entity is visible on the screen.   
            testRectangle.set(fX, fY, fWidth, fHeight);
            if (this._viewport.intersects(testRectangle)) {
                oX = item.origin ? item.origin.x : 0;
                oY = item.origin ? item.origin.y : 0;
       
                this._context.save();

                this._context.translate(item.destinationRectangle.x, item.destinationRectangle.y);
                this._context.translate(oX, oY);
                fX = -oX;
                fY = -oY;

                if (item.rotation) {
                    this._context.rotate(item.rotation);    
                }

                if (item.scale) {
                    this._context.scale(item.scale.x, item.scale.y);   
                }

                if (item.effect != Atlantis.SpriteEffect.None) {
                    if (item.effect == Atlantis.SpriteEffect.FlipHorizontaly) {
                        this._context.scale(-1, 1);
                        fX -= item.destinationRectangle.width;
                    }
                    else {
                        this._context.scale(1, -1);   
                        fY -= item.destinationRectangle.height; 
                    }
                }

                if (item.type === Atlantis.BatchItemType.Texture) { 
                    if (item.color &amp;&amp; item.texture2D.width &amp;&amp; item.texture2D.height) {
                        Atlantis.SpriteBatch.drawTexture(this._context, this._colorizeTexture(item.texture2D, item.color), fX, fY, fWidth, fHeight, item.sourceRectangle);  
                    }
                    else {
                        Atlantis.SpriteBatch.drawTexture(this._context, item.texture2D, fX, fY, fWidth, fHeight, item.sourceRectangle); 
                    }
                }
                else if (item.type === Atlantis.BatchItemType.Font) {
                    this._context.fillStyle = item.color;
                    this._context.font = item.spriteFont.getFont();
                    this._context.fillText(item.text, fX, fY);
                }

                this._context.restore();
            }
        }
        
         if (this._transformMatrix) {
            this._context.restore();
         }

        // Flush renderTarget into backbuffer
        this._graphicsDevice.getBackBuffer().getContext().drawImage(this._canvas, 0, 0, this._viewport.width, this._viewport.height);
      //  this._graphicsDevice.present();
        this._batchItems.length = 0;
        this._batchStarted = false;
    }
};

/**
 * Draw a texture on the screen
 * @method drawTexture
 * @static
 * @param {CanvasContext} The canvas context.
 * @param {Image} The image or canvas to draw.
 * @param {Number} x coordinate.
 * @param {Number} y coordinate.
 * @param {Number} width of the image.
 * @param {Number} height of the image.
 * @param {Atlantis.Rectangle} A source rectangle.
 */
Atlantis.SpriteBatch.drawTexture  = function (context, texture, x, y, width, height, sourceRectangle) {
    if (sourceRectangle) { 
        context.drawImage(texture, sourceRectangle.x, sourceRectangle.y, sourceRectangle.width, sourceRectangle.height, x, y, width, height); 
    }
    else {
        context.drawImage(texture, x, y, width, height);
    }
};

/**
 * Draw a texture on the screen
 * @method draw
 * @param {Image} The image or canvas to draw.
 * @param {Atlantis.Rectangle|Atlantis.Vector2} The position or the rectangle of the image.
 * @param {Atlantis.Rectangle} A source rectangle.
 * @param {String} A color to apply on the image in hex format.
 * @param {Number} Rotation of the image.
 * @param {Atlantis.Vector2} Origin of the image (defaut is 0, 0 on top/left).
 * @param {Atlantis.Vector2} Scale of the image (default is 1/1);
 * @param {Atlantis.SpriteEffect} An effect to apply (default is none).
 * @param {Number} The layer depth (Important when SpriteSortMode is set to BackToFront or FrontToBack).
 */
Atlantis.SpriteBatch.prototype.draw = function (texture2D, destinationRectangle, sourceRectangle, color, rotation, origin, scale, effect, layerDepth) {
    if (this._batchStarted) {
        if (!destinationRectangle.width) {
            destinationRectangle.width = texture2D.width;
            destinationRectangle.height = texture2D.height;
        }

        this._batchItems.push({ 
            type: Atlantis.BatchItemType.Texture, 
            texture2D: texture2D, 
            sourceRectangle: sourceRectangle, 
            destinationRectangle: destinationRectangle, 
            color: color, 
            rotation: rotation,
            origin: origin, 
            scale: scale,
            effect: effect ? effect : Atlantis.SpriteEffect.None, 
            layerDepth: (typeof(layerDepth) === &quot;number&quot;) ? layerDepth : 0 
        });
    }
};

/**
 * Draw a string on the screen
 * @method drawString
 * @param {Atlantis.SpriteFont} The SpriteFont to use.
 * @param {String} The string to draw.
 * @param {Atlantis.Vector2} The position of the string.
 * @param {String} The color of the string in hex format.
 * @param {Number} Rotation of the image.
 * @param {Atlantis.Vector2} Origin of the image (defaut is 0, 0 on top/left).
 * @param {Atlantis.Vector2} Scale of the image (default is 1/1);
 * @param {Atlantis.SpriteEffect} An effect to apply (default is none).
 * @param {Number} The layer depth (Important when SpriteSortMode is set to BackToFront or FrontToBack).
 */
Atlantis.SpriteBatch.prototype.drawString = function (spriteFont, text, position, color, rotation, origin, scale, effect, layerDepth) {
    if (this._batchStarted) {
        this._batchItems.push({ 
            type: Atlantis.BatchItemType.Font, 
            spriteFont: spriteFont, 
            text: text, 
            destinationRectangle: { x: position.x, y: position.y, width: 1, height: 1 }, 
            color: color, 
            rotation: rotation,
            origin: origin, 
            scale: scale,
            effect: effect ? effect : Atlantis.SpriteEffect.None, 
            layerDepth: (typeof(layerDepth) === &quot;number&quot;) ? layerDepth : 0 
        });   
    }
};

// Colorize a texture and put it in a cache.
Atlantis.SpriteBatch.prototype._colorizeTexture = function (texture, color) {
    var canvas = this._searchColoredTexture(texture, color);
    
    if (!canvas) {
        canvas = document.createElement(&quot;canvas&quot;);
        canvas.width = texture.width;
        canvas.height = texture.height;

        var context = canvas.getContext(&quot;2d&quot;);
        context.drawImage(texture, 0, 0);

        var imageData = context.getImageData(0, 0, texture.width, texture.height);
        var cColor = this._hexaToBytes(color);
        
        for (var i = 0, l = imageData.data.length; i &lt; l; i += 4) {
            imageData.data[i] = cColor.r | imageData.data[i];
            imageData.data[i + 1] = cColor.g | imageData.data[i + 1];
            imageData.data[i + 2] = cColor.b | imageData.data[i + 2]; 
            imageData.data[i + 3] = cColor.a | imageData.data[i + 3]; 
        }

        context.putImageData(imageData, 0, 0);

        this._cacheColoredTextures.push({ texture: texture, color: color, canvas: canvas });
    } 
    
    return canvas;
};

// Convert an hexa color to byte color.
Atlantis.SpriteBatch.prototype._hexaToBytes = function (color) {
    var hexa = color.split(&quot;#&quot;)[1];
    var bColor = { r: 0, g: 0, b: 0, a: 0 };
    var size = hexa.length;

    if (size === 3) {
        bColor.r = parseInt((hexa[0] + hexa[0]), 16);
        bColor.g = parseInt((hexa[1] + hexa[1]), 16);
        bColor.b = parseInt((hexa[2] + hexa[2]), 16);
    }
    else if (size === 6) {
        bColor.r = parseInt(hexa.slice(0, 2), 16);
        bColor.g = parseInt(hexa.slice(2, 4), 16);
        bColor.b = parseInt(hexa.slice(4, 6), 16);
    }
    else if (size === 8) {
        bColor.r = parseInt(hexa.slice(0, 2), 16);
        bColor.g = parseInt(hexa.slice(2, 4), 16);
        bColor.b = parseInt(hexa.slice(4, 6), 16);
        bColor.a = parseInt(hexa.slice(6, 8), 16);
    }

    return bColor;
};

// Search if a colored texture is already in the cache.
Atlantis.SpriteBatch.prototype._searchColoredTexture = function(texture, color) {
    var i = 0;
    var size = this._cacheColoredTextures.length;
    var canvas = null;

    while (i &lt; size &amp;&amp; canvas === null) {
        canvas = (this._cacheColoredTextures[i].texture === texture &amp;&amp; this._cacheColoredTextures[i].color === color) ? this._cacheColoredTextures[i].canvas : null;
        i++;
    }

    return canvas;
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
