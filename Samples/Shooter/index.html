<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Atlantis Game Engine</title>
</head>
<body>
<script>
    requestAnimationFrame = window.requestAnimationFrame || mozRequestAnimationFrame;
</script>
<script src="../../Framework/AudioManager.js"></script>
<script src="../../Framework/ContentManager.js"></script>
<script src="../../Framework/GameComponent.js"></script>
<script src="../../Framework/Graphics.js"></script>
<script src="../../Framework/Helpers.js"></script>
<script src="../../Framework/Rectangle.js"></script>
<script src="../../Framework/Vector2.js"></script>
<script src="../../Framework/Input/KeyboardState.js"></script>
<script src="../../Framework/Input/MouseState.js"></script>
<script src="../../Framework/Input/TouchState.js"></script>
<script src="../../Framework/Game.js"></script>
<script src="../../Engine/Atlantis.js"></script>
<script src="../../Engine/Display/Sprite.js"></script>
<script>
    // 
    // -- DEFINE THE SCROLLING BACKGROUND AND GUI
    //
    var Background = function (game) {
        Atlantis.DrawableGameComponent.call(this);

        // Define a star entity
        var StarEntity = function (x, y, size, color) {

            var position = { x: x, y: y };
            this.speed = 0.4;

            this.update = function (gameTime) {
                if (position.y > game.height) {
                    position.y = 0;
                }

                position.y += gameTime * this.speed;
            };

            this.draw = function (gameTime, context) {
                Atlantis.Graphics.drawCircle(context, position.x, position.y, size, color);
            };
        };

        var stars = [];
        var nbStars = 50;
        var score = 0;

        for (var i = 0; i < nbStars; i++) {
            stars.push(new StarEntity(Math.random() * game.width, Math.random() * game.height, Math.random() * 2, (Math.random() * 3) > 1 ? "#F8FF75" : "#9A7EB5"));
        }

        document.addEventListener("scoreChanged", function (event) {
            score += event.score;
        }, false);

        this.changeSpeed = function (value) {
            for (var i = 0; i < nbStars; i++) {
                stars[i].speed = value;
            }
        }

        // Update all stars
        this.update = function (gameTime) {
            for (var i = 0; i < nbStars; i++) {
                stars[i].update(gameTime);
            }

            if (game.keyboard.keys[Keys.up]) {
                this.changeSpeed(1);
            }
            else {
                this.changeSpeed(0.4);
            }
        };

        // Draw all stars
        this.draw = function (gameTime, context) {
            for (var i = 0; i < nbStars; i++) {
                stars[i].draw(gameTime, context);
            }

            Atlantis.Graphics.drawText(context, "Player 1 - " + score + " points", 140, 30, { color: "#ccc", size: 20 });
        };
    };

    Background.prototype = new Atlantis.DrawableGameComponent();

    //
    // DEFINE AN ENEMY
    //
    var Enemy = function (game, x, y, type) {

        var texture = null;

        if (type > 2) {
            texture = game.content.load("Content/Enemy_1.png");
        }
        else {
            texture = game.content.load("Content/Enemy_2.png");
        }

        var speed = 0.2;
        this.enabled = true;
        this.position = { x: x, y: y };
        this.rectangle = new Atlantis.Rectangle(this.position.x, this.position.y, 64, 64);

        this.update = function (gameTime) {
            this.position.y += gameTime * speed;
            this.rectangle.y = this.position.y;
        };

        this.draw = function (gameTime, context) {
            context.drawImage(texture, this.position.x, this.position.y);
        }
    };

    //
    // DEFINE AN AMMO
    //
    var Ammo = function (game, x, y) {
        var texture = game.content.load("Content/Ammo.png");
        var position = { x: x, y: y };
        var speed = 0.5;

        this.enabled = true;
        this.rectangle = new Atlantis.Rectangle(position.x, position.y, 4, 8);

        this.update = function (gameTime) {
            position.y -= gameTime * speed;
            this.rectangle.y = position.y;
        };

        this.draw = function (gameTime, context) {
            context.drawImage(texture, position.x, position.y);
        }
    };

    //
    // THE PLAYER CLASS
    // 
    var Player = function (game) {
        Atlantis.DrawableGameComponent.call(this);

        var speed = 0.6;
        var size = { x: 52, y: 52 };
        var position = { x: (game.width / 2) - (size.x / 2), y: game.height - (2 * size.y) };
        var texture = game.content.load("Content/ShipR.png");
        this.ammos = [];
        var ammoSound = game.content.load("Content/fire.wav");
        var shootInterval = null;
        var canShoot = true;

        this.update = function (gameTime) {
            if (game.keyboard.keys[Keys.left] && position.x > 0) {
                position.x -= speed * gameTime;
            }
            else if (game.keyboard.keys[Keys.right] && position.x + size.x < game.width) {
                position.x += speed * gameTime;
            }

            if (game.keyboard.keys[Keys.up] && position.y > 0) {
                position.y -= speed * gameTime;
            }
            else if (game.keyboard.keys[Keys.down] && position.y + size.y < game.height) {
                position.y += speed * gameTime;
            }

            if (canShoot && game.keyboard.keys[Keys.space]) {
                var ammo = new Ammo(game, position.x + 8, position.y - 5);
                this.ammos.push(ammo);
                ammoSound.play();
                canShoot = false;

                shootInterval = setInterval(function (t) {
                    canShoot = true;
                    clearInterval(shootInterval);
                }, 200);
            }

            for (var i in this.ammos) {
                if (this.ammos[i].enabled) {
                    this.ammos[i].update(gameTime);
                }
            }
        };

        this.draw = function (gameTime, context) {

            context.drawImage(texture, position.x, position.y);

            for (var i in this.ammos) {
                if (this.ammos[i].enabled) {
                    this.ammos[i].draw(gameTime, context);
                }
            }
        };
    };

    Player.prototype = new Atlantis.DrawableGameComponent();

    // 
    // THE MAIN GAME CLASS
    //
    var Game = function () {
        Atlantis.Game.call(this, 320, 540);

        this.initialize();

        var music = this.content.load("Content/DST-DasElectron.mp3");
        music.play();

        var background = new Background(this);
        this.components.add(background);

        var player = new Player(this);
        this.components.add(player);

        var enemies = [];
        var enemiesToRemove = [];
        var canSpawn = true;
        var spawnInterval = null;

        this.spawnNewEnemy = function (x, y) {
            enemies.push(new Enemy(this, x, y, Math.random() * 3));
            canSpawn = false;
            spawnInterval = setInterval(function (t) {
                canSpawn = true;
                clearInterval(spawnInterval);
            }, 3000);
        };

        // Override the base method
        this.update = function (gameTime) {
            Atlantis.Game.prototype.update.call(this, gameTime);

            if (canSpawn) {
                this.spawnNewEnemy(Math.random() * this.width, 0);
            }

            for (var i = 0, l = enemies.length; i < l; i++) {
                if (enemies[i].enabled) {
                    enemies[i].update(gameTime);

                    // Test if a laser collide with an enemy
                    for (var j = 0, k = player.ammos.length; j < k; j++) {
                        if (enemies[i].rectangle.intersects(player.ammos[j].rectangle)) {
                            enemies[i].enabled = false;
                            player.ammos[j].enabled = false;
                            Atlantis.notify("scoreChanged", { score: 15 });
                        }
                    }
                }
            }
        };

        this.draw = function (gameTime, context) {
            Atlantis.Game.prototype.draw.call(this, gameTime, context);

            for (var i = 0, l = enemies.length; i < l; i++) {
                if (enemies[i].enabled) {
                    enemies[i].draw(gameTime, context);
                }
            }
        };
    };

    Game.prototype = new Atlantis.Game();
</script>
<script>
    var game = new Game();

    (function loop() {
        requestAnimationFrame(loop);
        game.run();
    })();
</script>
</body>
</html>